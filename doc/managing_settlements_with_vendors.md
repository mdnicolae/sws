##  Settlements

### Introduction

---

When a customer makes a payment for an order, the entire amount is meant to be transferred to administrator's account. 
Each order carries a commission, and vendors can initiate the withdrawal of their earnings through the settlement process. 
This approach ensures a controlled and transparent financial ecosystem, providing administrators and vendors with flexibility over their financial transactions.

`OpenMarketplace` does not automatically transfer funds from the administrator to vendor accounts.
However, it is possible to integrate it with other payment gateways and automate the process of transferring funds to the vendor's account .

### Settlement frequency

---

Administrator can assign different settlement frequencies to vendors.
Settlements are generated based on the assigned frequency and contain information about the period the settlement covers.
For example, with a weekly settlement frequency, settlements are generated every week, covering the transactions paid previous week.
The inclusion factor for a particular period is defined by the `paidAt` property of the `Order` entity.

Settlements might be generated for the following frequencies:
- `weekly` - settlements are generated every week,
- `monthly` - settlements are generated every month,
- `quarterly` - settlements are generated every quarter,

Important note: Frequencies are dictating periods for which settlements are generated.
Weekly settlement will be generated for previous week, monthly for previous month and quarterly for previous quarter.
Profit for orders paid in this settlement frequency period will be settled in the next settlement frequency period.

E.g. If you have weekly settlement frequency, settlement for `2024-01-01` - `2024-01-07` will be generated during first run of command after `2024-01-07 23:59:59`.
This settlement will contain all orders paid between `2024-01-01 00:00:00` and `2024-01-07 23:59:59`.

To generate settlements, use `/docker/cron/crontab` file, make sure it contains line :
``` bash
0 9 * * 1 php /srv/sylius/bin/console bitbag:settlement:generate
```

#### Settlement frequency categories

Settlements can be divided into 2 categories based on the way they are created.
All settlement frequencies mentioned above are `cyclical` - they are generated by cron job.
However, there is one more `non-cyclical` settlement frequency- `virtual_wallet`.
Non-cyclical settlements are generated by vendor.

### States

---

Settlements have 3 available states, which are managed by state machine:
- `new` - the settlement is generated and not yet accepted by the seller,
- `accepted` - the settlement is accepted by the seller but not yet marked as paid,
- `settled` - the settlement is paid,

### Transitions

---

The state machine has 2 transitions:
- `accept` - moves the settlement from `new` to `accepted` when settlement for given period is accepted by the seller,
- `settle` - moves the settlement from `accepted` to `paid` when the settlement is paid,

### Payment gateway integration

---

Out-of-the-box state machine applies `settle` transition during `accept` callback in `SettlementCallbacks`.

```php
final class SettlementCallbacks implements SettlementCallbacksInterface
{
    public function __construct(
        private SettlementStateMachineTransitionInterface $settlementStateMachineTransition,
        private EntityManagerInterface $entityManager,
    ) {
    }

    public function payout(SettlementInterface $settlement): void
    {
        $this->settlementStateMachineTransition->applyIfCan(
            $settlement,
            SettlementTransitions::SETTLE,
        );

        $this->entityManager->flush();
    }
}
```

If you want to integrate OpenMarketplace with payment gateway, the best way is to override `SettlementCallbacks::payout`.
There you can implement logic responsible for payout processing.
 For the best result you should apply `settle` transition after successful payout confirmation.
